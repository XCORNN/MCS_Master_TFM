#!/bin/bash

# Función para mostrar mensajes de error
error_exit() {
  echo "$1" 1>&2
  exit 1
}

# Actualizar y mejorar el sistema
sudo apt update && sudo apt upgrade -y || error_exit "Error al actualizar el sistema"

# Instalar dependencias necesarias
sudo apt install -y gnupg2 apt-transport-https wget curl || error_exit "Error al instalar gnupg2, apt-transport-https, wget y curl"

# Importar clave pública de Microsoft
wget -q -O- https://packages.microsoft.com/keys/microsoft.asc | \
gpg --dearmor | sudo tee /usr/share/keyrings/microsoft.gpg > /dev/null 2>&1 || error_exit "Error al importar la clave pública de Microsoft"

# Añadir el repositorio de SQL Server
echo "deb [signed-by=/usr/share/keyrings/microsoft.gpg arch=amd64,armhf,arm64] https://packages.microsoft.com/ubuntu/22.04/mssql-server-2022 jammy main" | \
sudo tee /etc/apt/sources.list.d/mssql-server-2022.list || error_exit "Error al añadir el repositorio de SQL Server"

# Actualizar la lista de paquetes
sudo apt update || error_exit "Error al actualizar la lista de paquetes"

# Instalar SQL Server
sudo apt install -y mssql-server || error_exit "Error al instalar mssql-server"

# Configurar SQL Server
sudo /opt/mssql/bin/mssql-conf setup || error_exit "Error al configurar SQL Server"

# Habilitar y verificar el estado del servicio de SQL Server
sudo systemctl enable mssql-server || error_exit "Error al habilitar el servicio de SQL Server"
sudo systemctl status mssql-server || error_exit "Error al verificar el estado del servicio de SQL Server"

# Instalar herramientas de SQL Server
curl https://packages.microsoft.com/keys/microsoft.asc | sudo tee /etc/apt/trusted.gpg.d/microsoft.asc || error_exit "Error al importar la clave pública de Microsoft para herramientas SQL"

curl https://packages.microsoft.com/config/ubuntu/22.04/prod.list | sudo tee /etc/apt/sources.list.d/mssql-release.list || error_exit "Error al añadir el repositorio de herramientas SQL Server"

sudo apt-get update || error_exit "Error al actualizar la lista de paquetes después de añadir el repositorio de herramientas SQL Server"
sudo apt-get install -y mssql-tools18 || error_exit "Error al instalar mssql-tools18"

# Agregar /opt/mssql-tools18/bin/ al PATH
echo 'export PATH="$PATH:/opt/mssql-tools18/bin"' >> ~/.bash_profile || error_exit "Error al modificar .bash_profile"
echo 'export PATH="$PATH:/opt/mssql-tools18/bin"' >> ~/.bashrc || error_exit "Error al modificar .bashrc"
source ~/.bashrc || error_exit "Error al recargar .bashrc"

echo "Instalación y configuración de SQL Server completadas exitosamente."
